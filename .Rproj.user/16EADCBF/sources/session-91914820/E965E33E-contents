---
title: "Background & pseudo-absence data"
format: html
editor: visual
draft: false
---

```{r}
#| label: pagesetup-backgrounddata
#| echo: false
#| include: false
#| warning: false
#| message: false


# Load packages
source("scripts/load_packages.R")

# Load pre-saved spatial and occurrence data
load("data/workshop_data.RData")

Clim_UK <- terra::rast("data/Clim_UK.tif")
Elev_UK <- terra::rast("data/Elev_UK.tif")
```

Species distribution modelling (SDM) relies on comparing where a species occurs to where it does not, yet in practice **true absence data are extremely difficult to obtain**. In most biodiversity databases such GBIF, the records available are presence-only. Demonstrating a true absence requires very intensive sampling: for plants, complete and repeated inventories across large areas; for birds and other mobile or cryptic animals, repeated visits of the sampling plot. Even with rigorous protocols, imperfect detection means that non-detections can represent false negatives rather than genuine absences. Because systematic presence‚Äìabsence surveys are rare, ecologists frequently turn to background or pseudo-absence data to make presence-only datasets usable in SDM. These data do not attempt to identify where a species is truly absent, but instead provide a contrast set of conditions against which the environments of presences can be evaluated. In this sense, background data characterise the environmental or geographic domain of the study, while presences identify where within that domain the species has been observed.

Over the past decade, numerous approaches have been developed for generating background or pseudo-absence data. Early methods focused on simple random sampling of points across a study region, or on excluding presence cells. More recent advances emphasise accounting for spatial sampling bias (e.g., target-group selection, bias weighting) and ecological representativeness (e.g., sampling in environmental space). These innovations recognise that poorly chosen background data can bias response curves, inflate model accuracy, and limit transferability. State-of-the-art methods now include hybrid strategies that combine geographic, environmental, and effort-based information, as well as point process frameworks that embed background generation into a statistically principled likelihood. Despite this progress, there is still no universal solution: the most appropriate strategy depends on study goals, data sources, and the ecological processes under investigation.

We will look at two major ways of creating background/pseudo-absence data: ‚Ä¢ random selection of points within study area ‚Ä¢ accounting for spatial sampling bias using target-group selection

<br>

::: {.callout-note collapse="true" icon="lightbulb"}
### Why true absence data are so difficult to obtain

Imperfect detectability and survey effort. A non-detection at a site does not imply true absence; detectability varies with observer skill, time of day/season, survey method and effort. Many occurrence databases (e.g., opportunistic citizen science or museum records) lack repeat surveys that would allow occupancy/detection modelling.

Sampling bias. Areas that are more accessible, near roads, near research stations or urban centres tend to be oversampled. That produces presence records that reflect observer effort rather than the species' true ecological niche.

Scale mismatch. True absence at one spatial grain (e.g., 1 km) may be false at a finer grain (microhabitat), which complicates how absence is defined relative to predictors.

Logistical & cost constraints. Systematic presence-absence surveys are expensive and rarely available for many taxa and regions; hence reliance on presence-only data is common in applied SDMs.

These limitations motivate careful design of background/pseudo-absence strategies so that the data used for "absence" (or availability) reflect the ecological process of interest (and do not simply encode observer bias).
:::

<br>

## 1. Random selection of points within study area

Below, we demonstrate how to generate random background points within the spatial extent of the UK using `terra` and `sf`. We will then visualise the presence points for *Rhinolophus hipposideros* together with these background points.

**Define study area and presence points**

```{r}
#| label: hide-clean-coordinates
#| echo: false
#| warning: false
#| message: false
#| include: false

# Fallback: clean the data silently in case the student hasn't done it yet
if (!exists("occ_rhinhipp_cleaned")) {
  
  # Recreate minimal cleaned object (this assumes occ_df_rhinhipp is already loaded)
  occ_unique_rhinhipp <- occ_df_rhinhipp %>% dplyr::distinct()

  occ_rhinhipp_flags <- CoordinateCleaner::clean_coordinates(
    occ_unique_rhinhipp,
    lon = "decimalLongitude",
    lat = "decimalLatitude",
    countries = "countryCode",
    tests = c("centroids", "duplicates", "equal", "gbif", "institutions", "zeros"),
    inst_rad = 10000
  )

  occ_rhinhipp_cleaned <- occ_unique_rhinhipp[occ_rhinhipp_flags$.summary, ]
}
```

```{r}
#| label: presence-points
#| echo: true
#| include: true
#| warning: false
#| message: false

# UK boundary (sf object)
study_area <- UK_sf

# Cleaned occurrence points for Rhinolophus hipposideros (convert to sf)
# Requires to generate occ_rhinhipp_cleaned in page "Species data
presence_sf <- occ_rhinhipp_cleaned %>%
  # Select only the columns key, decimalLatitude, decimalLongitude
  dplyr::select(species, key, decimalLatitude, decimalLongitude) %>%
  # Remove records with missing coordinates
  filter(!is.na(decimalLongitude), !is.na(decimalLatitude)) %>%
  # convert to sf object
  sf::st_as_sf(coords = c("decimalLongitude", "decimalLatitude"), crs = 4326)

# Check the number of presence points
n_presence <- nrow(presence_sf)
n_presence
```

### 1.1 Generate random background points

```{r}
#| label: generate-backgroundpoints
#| echo: true
#| include: true
#| warning: false
#| message: false

set.seed(2222)  # for reproducibility

# Number of background points to generate (commonly 1-10x presence points)
n_background <- n_presence

# Generate random points within UK polygon using sf::st_sample
background_points <- sf::st_sample(study_area, size = n_background, type = "random")

# Convert to sf object with POINT geometry
background_sf <- st_sf(geometry = background_points)

# Assign an ID for plotting/analysis
background_sf <- background_sf %>%
  mutate(type = "background")

presence_sf <- presence_sf %>%
  mutate(type = "presence")
```

**Visualize presence and background points on the UK map**

```{r}
#| label: plots-points
#| echo: true
#| include: true
#| warning: false
#| message: false

ggplot() +
  geom_sf(data = study_area, fill = "gray95", color = "black") +
  geom_sf(data = background_sf, aes(color = type, shape = type), alpha = 0.3, size = 1) +
  geom_sf(data = presence_sf, aes(color = type, shape = type), size = 1.5) +
  scale_color_manual(
    name = "Point type",
    values = c("background" = "#1f78b4", "presence" = "#6a3d9a")
  ) +
  scale_shape_manual(
    name = "Point type",
    values = c("background" = 16, "presence" = 17)
  ) +
  labs(
    title = "Presence and random background points",
    subtitle = "Background points randomly sampled within UK boundary"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11),
    legend.position = "right"  # show legend on the right
  )
```

### 1.2 Spatially constrained background points

Randomly selecting background points across the entire study area can lead to biased models, especially when occurrence data are not evenly distributed. Presence records often cluster in areas with higher accessibility or sampling effort, which may not represent the species' actual habitat preferences. By spatially constraining background points to be near presence records, we ensure that the background data reflect the same spatial biases as the presence data, leading to more accurate and ecologically meaningful models. This method has been highlighted as a robust approach to mitigate spatial sampling bias in SDMs. For instance, Barve et al. (2011) discussed how spatially constrained background sampling can improve model performance by aligning the background data distribution with that of the presence data.

```{r}
#| label: spatially-constrained-background
#| echo: true
#| warning: false
#| message: false
#| fig-width: 7
#| fig-height: 7
#| fig-align: center

library(sf)
library(ggplot2)

# Define buffer distance (to be used around presence points)
buffer_dist = 5000

# Define a function to generate background points near presence points
# Define a function to generate background points near presence points
generate_background_constr <- function(presence_sf, study_area, buffer_distance, n_points) {
  # Create a buffer around each presence point
  presence_buffer <- sf::st_buffer(presence_sf, dist = buffer_distance)
  
  # Combine all buffers into a single geometry
  combined_buffer <- sf::st_union(presence_buffer)
  combined_buffer <- sf::st_make_valid(combined_buffer)
  
  # Intersect buffer with study area to constrain background to that zone
  constrained_area <- sf::st_intersection(combined_buffer, study_area)
  
  # Generate random points within the constrained area
  background_points <- sf::st_sample(constrained_area, size = n_points, type = "random")
  
  # Convert to sf object with same CRS
  background_sf <- sf::st_sf(geometry = background_points, crs = sf::st_crs(presence_sf))
  
  return(background_sf)
}

# Generate spatially constrained background points
background_constr_sf <- generate_background_constr(presence_sf, study_area, buffer_dist, n_background)

# Visualize the presence and spatially contrained background points
ggplot() +
  geom_sf(data = study_area, fill = "gray95", color = "black") +
  geom_sf(data = presence_sf, aes(color = "Presence"), size = 1.5, shape = 17) +
  geom_sf(data = background_constr_sf, aes(color = "Background"), alpha = 0.3, size = 1) +
  scale_color_manual(values = c("Presence" = "#6a3d9a", "Background" = "#1f78b4")) +
  labs(
    title = "Presence and Spatially Constrained Background Points for Rhinolophus hipposideros",
    subtitle = "Background points generated within 5 km of presence records",
    color = "Point Type"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11)
  )
```

## 2. Accounting for spatial sampling bias using target-group selection

The spatial distribution of species observations is often driven more by **where observers go** than by where the species truly occurs. This leads to spatial sampling bias, which ‚Äî if uncorrected ‚Äî can distort species distribution models (SDMs). One effective strategy to mitigate this is **target-group background selection**. This method uses presence records of **other species** from the same group (e.g., all bats) that were collected using the same methods and sources (e.g., GBIF, citizen science) to approximate the same sampling bias.

The idea is simple: assume that the observer effort captured in the presence data of the target group reflects the same biases as for your focal species. Using this "effort surface" as background allows models to distinguish environmental preferences of the species from spatial artefacts of data collection.

We now generate background points for *Rhinolophus hipposideros* using other GBIF records for UK bats as the target group.

#### Define target group species

We define the target group as **all bat species** recorded in Great Britain. You can adapt this list depending on your study needs.

::: {.callout-note collapse="true"}
### Code to generate the target group species background points (already done in data preparation)

```{r}
#| label: rgbif-targetpts
#| eval: false
#| include: false
#| warning: false
#| message: false

library(rgbif)

# Define target group (Chiroptera = bats)
bat_taxon_key <- name_backbone(name = "Chiroptera")$usageKey

# Download bat occurrence records from GBIF
bat_occ <- rgbif::occ_search(
  taxonKey = bat_taxon_key,
  country = "GB",
  hasCoordinate = TRUE,
  limit = 2000  # increase if needed, but beware GBIF limits
)

# Extract data
bat_df <- bat_occ$data

# Remove records for the focal species (Rhinolophus hipposideros)
target_group_df <- bat_df %>%
  filter(!species %in% "Rhinolophus hipposideros") %>%
  filter(!is.na(decimalLongitude), !is.na(decimalLatitude)) %>%
  dplyr::select(species, decimalLatitude, decimalLongitude)

# Convert to sf object
target_group_sf <- st_as_sf(
  target_group_df,
  coords = c("decimalLongitude", "decimalLatitude"),
  crs = 4326
)
```

These steps are included in the data preparation file:\
üëâ [View full data preparation script](page_SDM.1_DataPreparation)
:::

<br>

#### Visualise target group background points

```{r}
#| label: plot_targetpts
#| echo: true
#| warning: false
#| message: false

# Check how many background records we have
nrow(target_group_sf)

# Plot target-group background vs presence points
ggplot() +
  geom_sf(data = study_area, fill = "gray95", color = "black") +
  geom_sf(data = presence_sf, aes(color = "Presence"), size = 2, shape = 17) +
  geom_sf(data = target_group_sf, aes(color = "Target group background"), size = 1, alpha = 0.6) +
  scale_color_manual(values = c("Presence" = "#6a3d9a", "Target group background" = "#33a02c")) +
  labs(
    title = "Presence and Target Group Background Points",
    subtitle = "Target-group: Other bat species recorded in the UK (GBIF)",
    color = "Point Type"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11)
  )
```

::: {.callout-note collapse="true"}
### When to use target-group background?

Target-group background is especially useful when: - Presence data are from opportunistic, bias-prone sources like GBIF or citizen science. - The focal species is part of a well-studied taxonomic group with sufficient records. - You want to reduce the impact of spatial sampling effort on model results.

It works best when the target group was sampled using the same methods, in the same places, and during the same time as the focal species. Poorly matched target groups can **worsen** bias, so always inspect their spatial distribution.
:::

::: {.callout-important collapse="true" icon="clipboard"}
### The choice to make...

There is no single "best" pseudo-absence or background approach that universally fits all objectives and applications. Good practice is to (1) understand your data and sampling process, (2) choose background/pseudo-absence strategies that emulate sampling or maximally inform the species-environment contrast relevant to your question, and (3) evaluate sensitivity across plausible alternatives while using spatially aware evaluation. The recent literature strongly favours bias-aware (target-group / weighted) and environmental-space approaches, and pushes toward methods that explicitly model sampling intensity or treat presences as a point process for principled inference.
:::

<br>

## 3. Join data (species presence, background/pseudo-absence, environmental data)

To model species-environment relationships, we need to combine the **species data** (presence and background/pseudo-absence points) with the **environmental data** (climate, elevation, etc.). This involves extracting raster values at point locations and joining these with species labels (`1` for presence, `0` for background/pseudo-absence).

We‚Äôll extract the environmental predictors from the following rasters: - `Clim_UK`: Bioclimatic variables from WorldClim - `Elev_UK`: Elevation at 30 arc-second resolution

These predictors will be joined to: - `presence_sf`: Points where *Rhinolophus hipposideros* was observed - `target_group_sf`: Target-group background points from other bat species

```{r}
#| label: fallback-env-stack
#| echo: false
#| warning: false
#| message: false
#| include: false

# Resample Elev_UK raster to match Clim_extant_UK_masked raster
Elev_UK_aligned <- terra::resample(Elev_UK, Clim_UK, method = "bilinear")

# Crop to common extent
common_extent <- intersect(ext(Clim_UK), ext(Elev_UK_aligned))
Clim_UK_crop2 <- terra::crop(Clim_UK, common_extent)
Elev_UK_crop2 <- terra::crop(Elev_UK_aligned, common_extent)

# Stack layers and name variables
Env_UK_stack <- c(Clim_UK_crop2 , Elev_UK_crop2)
names(Env_UK_stack) <- c(sub("^wc2\\.1_10m_", "", names(Clim_UK_crop2)), "elevation")

```

```{r}
#| label: join-SDM-data
#| warning: false
#| message: false

library(terra)
library(tidyverse)
library(sf)

# Use the stacked climate and elevation data generated in the page "Envionmental Data"
env_stack <- Env_UK_stack

# Extract environmental values at presence points
env_pres <- terra::extract(env_stack, vect(presence_sf)) %>%
  dplyr::select(-ID)  # Remove ID column returned by extract

# Combine with presence points
presence_data <- presence_sf %>%
  mutate(pa = 1) %>%  # 1 = presence
  bind_cols(env_pres)

# Extract environmental values at background points
env_back <- terra::extract(env_stack, vect(background_sf)) %>%
  dplyr::select(-ID)

# Combine with background points
background_data <- background_sf %>%
  mutate(pa = 0) %>%  # 0 = pseudo-absence
  bind_cols(env_back)

# Combine presence + background into one dataset for modelling
sdm_data <- bind_rows(presence_data, background_data)

# Drop geometry for model matrix if needed
sdm_df <- st_drop_geometry(sdm_data)

# Drop rows wit NA in covariates
sdm_df_clean <- sdm_df %>%
  drop_na(starts_with("bio_"), elevation)

# Preview
head(sdm_df_clean)
```

::: {.callout-note collapse="true" icon="info"}
### Exercises: Explore background and pseudo-absence strategies

1.  **Try a different background method:**\
    Replace the random background points with a spatially constrained version using buffers of 1 km, 5 km, and 10 km. Plot and compare the results. How does the choice of buffer size affect spatial coverage?

2.  **Target-group background for another species:**\
    Select a different focal species (e.g., *Pipistrellus pipistrellus*) and define an appropriate target group (e.g., other bat species). Generate target-group background points and compare their spatial distribution with your presence data.

3.  **Compare environmental distributions:**\
    Extract environmental values (e.g., climate, elevation) at presence and background points. Plot histograms or density plots to compare environmental coverage across different background sampling strategies.
:::

::: {.callout-note collapse="true" icon="lightbulb"}
### Readings

Baker, D. J., Maclean, I. M. D., & Gaston, K. J. (2024). **Effective strategies for correcting spatial sampling bias in species distribution models without independent test data.** *Diversity and Distributions*, 30(3), e13802. [doi:10.1111/ddi.13802](https://doi.org/10.1111/ddi.13802)

Barber, R. A., Ball, S. G., Morris, R. K. A., & Gilbert, F. (2022). **Target-group backgrounds prove effective at correcting sampling bias in Maxent models.** *Diversity and Distributions*, 28(1), 128‚Äì141. [doi:10.1111/ddi.13442](https://doi.org/10.1111/ddi.13442)

Barbet-Massin, M., Jiguet, F., Albert, C. H., & Thuiller, W. (2012). **Selecting pseudo-absences for species distribution models: how, where and how many?** *Methods in Ecology and Evolution*, 3(2), 327‚Äì338. doi:10.1111/j.2041-210X.2011.00172.x

Broussin, J., Mouchet, M., & Goberville, E. (2024). **Generating pseudo-absences in the ecological space improves the biological relevance of response curves in species distribution models.** *Ecological Modelling*, 498, 110865. [doi:10.1016/j.ecolmodel.2024.110865](https://doi.org/10.1016/j.ecolmodel.2024.110865)

Da¬†Re, D., Tordoni, E., Lenoir, J., Lembrechts, J. J., Vanwambeke, S. O., Rocchini, D., & Bazzichetto, M. (2023). **USE it: Uniformly sampling pseudo-absences within the environmental space for applications in habitat suitability models.** *Methods in Ecology and Evolution*, 14(11), 2873‚Äì2887. [doi:10.1111/2041-210X.14209](https://doi.org/10.1111/2041-210X.14209)

Kneib, T., Muller, J., & Hothorn, T. (2008). **Spatial smoothing techniques for the assessment of habitat suitability.** *Environmental and Ecological Statistics*, 15(3), 343‚Äì364. [doi:10.1007/s10651-008-0092-x](https://doi.org/10.1007/s10651-008-0092-x)

Kramer-Schadt, S. et al. (2013). **The importance of correcting for sampling bias in MaxEnt species distribution models.** *Diversity and Distributions*, 19(11), 1366‚Äì1379. [doi:10.1111/ddi.12096](https://doi.org/10.1111/ddi.12096)

Phillips, S.J., DudiÃÅk, M., Elith, J., Graham, C.H., Lehmann, A., Leathwick, J. & Ferrier, S. (2009) **Sample selection bias and presence-only distribution models: Implications for background and pseudo-absence data.** *Ecological Applications*, 19(1), 181‚Äì197. [doi:10.1890/07-2153.1](https://doi.org/10.1890/07-2153.1)
:::
